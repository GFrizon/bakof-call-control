{% extends "layout.html" %}
{% block title %}Gerenciar Usuários{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h2 class="fw-bold text-dark mb-1">
      <i class="bi bi-people-fill text-primary"></i> Gerenciar Usuários
    </h2>
    <p class="text-muted mb-0">Criar, editar e controlar acesso de usuários</p>
  </div>
  <button class="btn btn-success" onclick="abrirModalCriar()">
    <i class="bi bi-person-plus"></i> Novo Usuário
  </button>
</div>

<!-- Tabela de Usuários -->
<div class="card">
  <div class="card-header">
    <i class="bi bi-table"></i> Usuários do Sistema
  </div>
  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Nome</th>
          <th>Email</th>
          <th>Tipo</th>
          <th>Meta Diária</th>
          <th>Clientes</th>
          <th>Status</th>
          <th>Cadastro</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for u in usuarios %}
        <tr class="{% if not u.ativo %}text-muted{% endif %}">
          <td>
            <strong>{{ u.nome }}</strong>
            {% if u.id == current_user.id %}
              <span class="badge bg-info ms-2">Você</span>
            {% endif %}
          </td>
          <td>{{ u.email }}</td>
          <td>
            {% if u.tipo == 'supervisor' %}
              <span class="badge bg-primary">
                <i class="bi bi-shield-check"></i> Supervisor
              </span>
            {% else %}
              <span class="badge bg-secondary">
                <i class="bi bi-person"></i> Consultor
              </span>
            {% endif %}
          </td>
          <td>
            {% if u.tipo == 'consultor' %}
              <span class="badge bg-info">{{ u.meta_diaria }} ligações/dia</span>
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if u.tipo == 'consultor' %}
              <span class="badge bg-success">{{ u.total_clientes }}</span>
            {% else %}
              -
            {% endif %}
          </td>
          <td>
            {% if u.ativo %}
              <span class="badge bg-success">
                <i class="bi bi-check-circle"></i> Ativo
              </span>
            {% else %}
              <span class="badge bg-danger">
                <i class="bi bi-x-circle"></i> Inativo
              </span>
            {% endif %}
          </td>
          <td>
            <small class="text-muted">
              {{ u.data_cadastro.strftime('%d/%m/%Y') if u.data_cadastro else '-' }}
            </small>
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" 
                      onclick="abrirModalEditar({{ u.id }}, '{{ u.nome|e }}', '{{ u.email|e }}', '{{ u.tipo }}', {{ u.meta_diaria }})"
                      title="Editar">
                <i class="bi bi-pencil"></i>
              </button>
              
              <button class="btn btn-outline-warning" 
                      onclick="abrirModalRedefinirSenha({{ u.id }}, '{{ u.nome|e }}')"
                      title="Redefinir Senha">
                <i class="bi bi-key"></i>
              </button>
              
              {% if u.id != current_user.id %}
              <button class="btn btn-outline-{% if u.ativo %}danger{% else %}success{% endif %}" 
                      onclick="toggleStatus({{ u.id }}, '{{ u.nome|e }}', {{ 'true' if u.ativo else 'false' }})"
                      title="{% if u.ativo %}Inativar{% else %}Ativar{% endif %}">
                <i class="bi bi-{% if u.ativo %}x-circle{% else %}check-circle{% endif %}"></i>
              </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- MODAL CRIAR USUÁRIO -->
<div class="modal fade" id="modalCriar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form onsubmit="criarUsuario(event)">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-person-plus"></i> Criar Novo Usuário
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nome Completo *</label>
            <input type="text" class="form-control" id="criarNome" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Email *</label>
            <input type="email" class="form-control" id="criarEmail" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Senha *</label>
            <input type="password" class="form-control" id="criarSenha" required minlength="6">
            <small class="text-muted">Mínimo 6 caracteres</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Tipo de Usuário *</label>
            <select class="form-select" id="criarTipo" onchange="toggleMetaDiaria('criar')">
              <option value="consultor">Consultor</option>
              <option value="supervisor">Supervisor</option>
            </select>
          </div>
          
          <div class="mb-3" id="criarMetaContainer">
            <label class="form-label">Meta Diária de Ligações</label>
            <input type="number" class="form-control" id="criarMeta" value="10" min="1">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            Cancelar
          </button>
          <button type="submit" class="btn btn-success">
            <i class="bi bi-save"></i> Criar Usuário
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL EDITAR USUÁRIO -->
<div class="modal fade" id="modalEditar" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form onsubmit="editarUsuario(event)">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-pencil"></i> Editar Usuário
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editarId">
          
          <div class="mb-3">
            <label class="form-label">Nome Completo *</label>
            <input type="text" class="form-control" id="editarNome" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Email *</label>
            <input type="email" class="form-control" id="editarEmail" required>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Tipo de Usuário *</label>
            <select class="form-select" id="editarTipo" onchange="toggleMetaDiaria('editar')">
              <option value="consultor">Consultor</option>
              <option value="supervisor">Supervisor</option>
            </select>
          </div>
          
          <div class="mb-3" id="editarMetaContainer">
            <label class="form-label">Meta Diária de Ligações</label>
            <input type="number" class="form-control" id="editarMeta" value="10" min="1">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-save"></i> Salvar Alterações
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL REDEFINIR SENHA -->
<div class="modal fade" id="modalRedefinirSenha" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form onsubmit="redefinirSenha(event)">
        <div class="modal-header bg-warning">
          <h5 class="modal-title">
            <i class="bi bi-key"></i> Redefinir Senha
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="redefinirId">
          
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            Redefinindo senha de: <strong id="redefinirNome"></strong>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Nova Senha *</label>
            <input type="password" class="form-control" id="redefinirNovaSenha" required minlength="6">
            <small class="text-muted">Mínimo 6 caracteres</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Confirmar Nova Senha *</label>
            <input type="password" class="form-control" id="redefinirConfirmaSenha" required minlength="6">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
            Cancelar
          </button>
          <button type="submit" class="btn btn-warning">
            <i class="bi bi-key"></i> Redefinir Senha
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let modalCriar, modalEditar, modalRedefinirSenha;

document.addEventListener('DOMContentLoaded', () => {
  modalCriar = new bootstrap.Modal(document.getElementById('modalCriar'));
  modalEditar = new bootstrap.Modal(document.getElementById('modalEditar'));
  modalRedefinirSenha = new bootstrap.Modal(document.getElementById('modalRedefinirSenha'));
});

function toggleMetaDiaria(tipo) {
  const select = document.getElementById(tipo + 'Tipo');
  const container = document.getElementById(tipo + 'MetaContainer');
  container.style.display = select.value === 'consultor' ? 'block' : 'none';
}

function abrirModalCriar() {
  document.getElementById('criarNome').value = '';
  document.getElementById('criarEmail').value = '';
  document.getElementById('criarSenha').value = '';
  document.getElementById('criarTipo').value = 'consultor';
  document.getElementById('criarMeta').value = '10';
  toggleMetaDiaria('criar');
  modalCriar.show();
}

async function criarUsuario(e) {
  e.preventDefault();
  
  const payload = {
    nome: document.getElementById('criarNome').value,
    email: document.getElementById('criarEmail').value,
    senha: document.getElementById('criarSenha').value,
    tipo: document.getElementById('criarTipo').value,
    meta_diaria: parseInt(document.getElementById('criarMeta').value) || 10
  };
  
  try {
    const r = await fetch('/supervisor/usuarios/criar', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    
    const j = await r.json();
    
    if (j.ok) {
      modalCriar.hide();
      alert(j.mensagem);
      location.reload();
    } else {
      alert(j.mensagem || 'Erro ao criar usuário');
    }
  } catch (error) {
    alert('Erro: ' + error.message);
  }
}

function abrirModalEditar(id, nome, email, tipo, meta) {
  document.getElementById('editarId').value = id;
  document.getElementById('editarNome').value = nome;
  document.getElementById('editarEmail').value = email;
  document.getElementById('editarTipo').value = tipo;
  document.getElementById('editarMeta').value = meta || 10;
  toggleMetaDiaria('editar');
  modalEditar.show();
}

async function editarUsuario(e) {
  e.preventDefault();
  
  const id = document.getElementById('editarId').value;
  const payload = {
    nome: document.getElementById('editarNome').value,
    email: document.getElementById('editarEmail').value,
    tipo: document.getElementById('editarTipo').value,
    meta_diaria: parseInt(document.getElementById('editarMeta').value) || 10
  };
  
  try {
    const r = await fetch(`/supervisor/usuarios/${id}/editar`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
    
    const j = await r.json();
    
    if (j.ok) {
      modalEditar.hide();
      alert(j.mensagem);
      location.reload();
    } else {
      alert(j.mensagem || 'Erro ao editar usuário');
    }
  } catch (error) {
    alert('Erro: ' + error.message);
  }
}

function abrirModalRedefinirSenha(id, nome) {
  document.getElementById('redefinirId').value = id;
  document.getElementById('redefinirNome').textContent = nome;
  document.getElementById('redefinirNovaSenha').value = '';
  document.getElementById('redefinirConfirmaSenha').value = '';
  modalRedefinirSenha.show();
}

async function redefinirSenha(e) {
  e.preventDefault();
  
  const novaSenha = document.getElementById('redefinirNovaSenha').value;
  const confirmaSenha = document.getElementById('redefinirConfirmaSenha').value;
  
  if (novaSenha !== confirmaSenha) {
    alert('As senhas não conferem!');
    return;
  }
  
  const id = document.getElementById('redefinirId').value;
  
  try {
    const r = await fetch(`/supervisor/usuarios/${id}/redefinir-senha`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ nova_senha: novaSenha })
    });
    
    const j = await r.json();
    
    if (j.ok) {
      modalRedefinirSenha.hide();
      alert(j.mensagem);
    } else {
      alert(j.mensagem || 'Erro ao redefinir senha');
    }
  } catch (error) {
    alert('Erro: ' + error.message);
  }
}

async function toggleStatus(id, nome, ativo) {
  const acao = ativo ? 'inativar' : 'ativar';
  
  if (!confirm(`Tem certeza que deseja ${acao} o usuário ${nome}?`)) {
    return;
  }
  
  try {
    const r = await fetch(`/supervisor/usuarios/${id}/toggle-status`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    });
    
    const j = await r.json();
    
    if (j.ok) {
      alert(j.mensagem);
      location.reload();
    } else {
      alert(j.mensagem || 'Erro ao alterar status');
    }
  } catch (error) {
    alert('Erro: ' + error.message);
  }
}
</script>
{% endblock %}