{% extends "layout.html" %}
{% block title %}Gerenciar Banners{% endblock %}
{% block content %}

<div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between mb-4 gap-3">
  <div>
    <h2 class="m-0 fw-bold text-dark">
      <i class="bi bi-megaphone-fill text-primary"></i> Gerenciar Banners
    </h2>
    <p class="text-muted mb-0 mt-1">Crie e gerencie avisos para todos os usu치rios</p>
  </div>
  <div class="d-flex gap-2">
    <button class="btn btn-primary" onclick="abrirModalCriarBanner()">
      <i class="bi bi-plus-circle"></i> Novo Banner
    </button>
    <a href="{{ url_for('dashboard_supervisor') }}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Voltar
    </a>
  </div>
</div>

<!-- Lista de Banners -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <i class="bi bi-list-ul"></i> Banners Cadastrados
      </div>
      <div class="card-body">
        {% if banners %}
          <div class="table-container">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>T칤tulo</th>
                  <th>Mensagem</th>
                  <th>Tipo</th>
                  <th>Status</th>
                  <th>Data Expira칞칚o</th>
                  <th>Criado por</th>
                  <th>A칞칫es</th>
                </tr>
              </thead>
              <tbody>
                {% for banner in banners %}
                <tr>
                  <td>
                    <strong>{{ banner.titulo }}</strong>
                  </td>
                  <td>
                    <span class="text-truncate d-inline-block" style="max-width: 300px;" title="{{ banner.mensagem }}">
                      {{ banner.mensagem[:100] }}{% if banner.mensagem|length > 100 %}...{% endif %}
                    </span>
                  </td>
                  <td>
                    <span class="badge bg-{{ 'info' if banner.tipo == 'info' else 'warning' if banner.tipo == 'warning' else 'success' if banner.tipo == 'success' else 'danger' }}">
                      {{ banner.tipo.upper() }}
                    </span>
                  </td>
                  <td>
                    <span class="badge bg-{{ 'success' if banner.ativo else 'secondary' }}">
                      {{ 'Ativo' if banner.ativo else 'Inativo' }}
                    </span>
                  </td>
                  <td>
                    {% if banner.data_expiracao %}
                      <span class="text-muted">{{ banner.data_expiracao.strftime('%d/%m/%Y %H:%M') }}</span>
                    {% else %}
                      <span class="text-muted">Sem expira칞칚o</span>
                    {% endif %}
                  </td>
                  <td>
                    <small class="text-muted">{{ banner.criador.nome if banner.criador else 'Desconhecido' }}</small><br>
                    <small class="text-muted">{{ banner.data_criacao.strftime('%d/%m/%Y %H:%M') }}</small>
                  </td>
                  <td>
                    <div class="btn-group" role="group">
                      <button type="button" class="btn btn-sm btn-outline-{{ 'success' if banner.ativo else 'warning' }}" 
                              onclick="toggleStatus({{ banner.id }})" 
                              title="{{ 'Desativar' if banner.ativo else 'Ativar' }}">
                        <i class="bi bi-{{ 'pause-circle' if banner.ativo else 'play-circle' }}"></i>
                      </button>
                      <button type="button" class="btn btn-sm btn-outline-danger" 
                              onclick="excluirBanner({{ banner.id }})" 
                              title="Excluir">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-5">
            <i class="bi bi-megaphone text-muted" style="font-size: 3rem;"></i>
            <h5 class="text-muted mt-3">Nenhum banner cadastrado</h5>
            <p class="text-muted">Clique em "Novo Banner" para criar seu primeiro aviso.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Modal Criar Banner -->
<div class="modal fade" id="modalCriarBanner" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i> Criar Novo Banner
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="formCriarBanner">
        <div class="modal-body">
          <div class="mb-3">
            <label for="titulo" class="form-label">T칤tulo <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="titulo" name="titulo" required maxlength="200">
            <div class="form-text">T칤tulo curto e chamativo para o aviso.</div>
          </div>
          
          <div class="mb-3">
            <label for="mensagem" class="form-label">Mensagem <span class="text-danger">*</span></label>
            <textarea class="form-control" id="mensagem" name="mensagem" rows="4" required></textarea>
            <div class="form-text">Descri칞칚o detalhada do aviso que ser치 exibido para os usu치rios.</div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="tipo" class="form-label">Tipo do Banner</label>
                <select class="form-select" id="tipo" name="tipo">
                  <option value="info">游댯 Informativo</option>
                  <option value="warning">游리 Aviso</option>
                  <option value="success">游릭 Sucesso</option>
                  <option value="danger">游댮 Urgente</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="data_expiracao" class="form-label">Data de Expira칞칚o</label>
                <input type="date" class="form-control" id="data_expiracao" name="data_expiracao">
                <div class="form-text">Opcional. Banner ser치 desativado automaticamente nesta data.</div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Cancelar
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle"></i> Criar Banner
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function abrirModalCriarBanner() {
  const modal = new bootstrap.Modal(document.getElementById('modalCriarBanner'));
  document.getElementById('formCriarBanner').reset();
  modal.show();
}

// Criar Banner
document.getElementById('formCriarBanner').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const data = Object.fromEntries(formData);
  
  try {
    const response = await fetch('/supervisor/banners/criar', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (result.ok) {
      bootstrap.Modal.getInstance(document.getElementById('modalCriarBanner')).hide();
      location.reload();
    } else {
      alert('Erro: ' + result.mensagem);
    }
  } catch (error) {
    alert('Erro ao criar banner: ' + error.message);
  }
});

// Toggle Status
async function toggleStatus(bannerId) {
  if (!confirm('Tem certeza que deseja alterar o status deste banner?')) {
    return;
  }
  
  try {
    const response = await fetch(`/supervisor/banners/${bannerId}/toggle-status`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const result = await response.json();
    
    if (result.ok) {
      location.reload();
    } else {
      alert('Erro: ' + result.mensagem);
    }
  } catch (error) {
    alert('Erro ao alterar status: ' + error.message);
  }
}

// Excluir Banner
async function excluirBanner(bannerId) {
  if (!confirm('Tem certeza que deseja excluir este banner? Esta a칞칚o n칚o pode ser desfeita.')) {
    return;
  }
  
  try {
    const response = await fetch(`/supervisor/banners/${bannerId}/excluir`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const result = await response.json();
    
    if (result.ok) {
      location.reload();
    } else {
      alert('Erro: ' + result.mensagem);
    }
  } catch (error) {
    alert('Erro ao excluir banner: ' + error.message);
  }
}
</script>
{% endblock %}
