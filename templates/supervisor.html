{% extends "layout.html" %}
{% block title %}Dashboard Supervisor{% endblock %}
{% block content %}

<!-- üÜï POP-UP DE NOVIDADES -->
{% if mostrar_novidades %}
<div class="modal fade show" id="modalNovidades" tabindex="-1" style="display: block; background: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-stars"></i> üéâ Novidades da Atualiza√ß√£o!
        </h5>
      </div>
      <div class="modal-body">
        <div class="alert alert-info mb-3">
          <i class="bi bi-info-circle"></i> <strong>Vers√£o 2.0</strong> - Confira as novidades!
        </div>
        
        <ul class="list-unstyled">
          <li class="mb-3">
            <i class="bi bi-pencil-square text-success fs-5"></i>
            <strong>Editar observa√ß√µes</strong><br>
            <small class="text-muted">Agora voc√™ pode editar as observa√ß√µes das liga√ß√µes j√° registradas!</small>
          </li>
          
          <li class="mb-3">
            <i class="bi bi-calendar-range text-primary fs-5"></i>
            <strong>Filtro por m√™s</strong><br>
            <small class="text-muted">Visualize o desempenho dos consultores m√™s a m√™s. Use o filtro abaixo dos cards!</small>
          </li>
          
          <li class="mb-3">
            <i class="bi bi-bell text-warning fs-5"></i>
            <strong>Sistema de notifica√ß√µes</strong><br>
            <small class="text-muted">Fique por dentro das atualiza√ß√µes do sistema!</small>
          </li>
        </ul>
        
        <div class="alert alert-success mb-0">
          <i class="bi bi-check-circle"></i> Todas as funcionalidades anteriores continuam funcionando normalmente!
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="fecharNovidades()">
          <i class="bi bi-check-lg"></i> Entendi!
        </button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<div class="mb-4">
  <h2 class="fw-bold text-dark mb-1">
    <i class="bi bi-speedometer2 text-primary"></i> Dashboard do Supervisor
  </h2>
  <p class="text-muted">Vis√£o geral do desempenho da equipe</p>
</div>

<!-- Bot√£o para enviar o resumo agora -->
<div class="d-flex justify-content-end mb-3">
  <a class="btn btn-primary btn-sm" href="{{ url_for('admin_enviar_relatorio') }}">
    <i class="bi bi-send"></i> Enviar resumo agora
  </a>
</div>

<!-- Cards de Estat√≠sticas -->
<div class="row g-4 mb-4">
  <div class="col-md-3">
    <div class="stat-card" style="border-left-color: #2563eb;">
      <div class="stat-icon" style="background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(59, 130, 246, 0.1)); color: #2563eb;">
        <i class="bi bi-people-fill"></i>
      </div>
      <div class="stat-value">{{ total_consultores }}</div>
      <div class="stat-label">Consultores Ativos</div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="stat-card" style="border-left-color: #10b981;">
      <div class="stat-icon" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); color: #10b981;">
        <i class="bi bi-building"></i>
      </div>
      <div class="stat-value">{{ total_clientes }}</div>
      <div class="stat-label">Total de Clientes</div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="stat-card" style="border-left-color: #f59e0b;">
      <div class="stat-icon" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); color: #f59e0b;">
        <i class="bi bi-telephone-fill"></i>
      </div>
      <div class="stat-value">{{ total_ligacoes }}</div>
      <div class="stat-label">Total de Liga√ß√µes</div>
    </div>
  </div>
  
  <div class="col-md-3">
    <div class="stat-card" style="border-left-color: #06b6d4;">
      <div class="stat-icon" style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(8, 145, 178, 0.1)); color: #06b6d4;">
        <i class="bi bi-calendar-check"></i>
      </div>
      <div class="stat-value">{{ ligacoes_hoje }}</div>
      <div class="stat-label">Liga√ß√µes Hoje</div>
      {% if ligacoes_hoje > 0 %}
        <div class="stat-change positive">
          <i class="bi bi-graph-up-arrow"></i> Ativo hoje
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- üÜï FILTRO POR M√äS/ANO -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row align-items-center">
      <div class="col-md-6">
        <h5 class="mb-0">
          <i class="bi bi-funnel"></i> Filtrar Desempenho por Per√≠odo
        </h5>
        <small class="text-muted">Selecione o m√™s/ano para visualizar o desempenho dos consultores</small>
      </div>
      <div class="col-md-6">
        <div class="row g-2">
          <div class="col-md-8">
            <select class="form-select" id="filtroMes" onchange="aplicarFiltroMes()">
              {% for m in meses_disponiveis %}
              <option value="{{ m.mes }}-{{ m.ano }}" {% if m.mes == mes_filtro and m.ano == ano_filtro %}selected{% endif %}>
                {{ m.texto }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100" onclick="aplicarFiltroMes()">
              <i class="bi bi-search"></i> Filtrar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- üÜï TABELA DE RESULTADOS FILTRADOS -->
<div class="row g-4 mb-4" id="resultadosFiltrados" style="display: none;">
  <div class="col-12">
    <div class="card">
      <div class="card-header bg-primary text-white">
        <i class="bi bi-calendar3"></i> Resultados do Per√≠odo - <span id="periodoSelecionado"></span>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Consultor</th>
                <th class="text-center">Total Liga√ß√µes</th>
                <th class="text-center">Vendas</th>
                <th class="text-center">Convers√£o</th>
                <th class="text-end">Receita</th>
              </tr>
            </thead>
            <tbody id="tbodyResultados">
              <tr>
                <td colspan="5" class="text-center">
                  <div class="spinner-border text-primary" role="status"></div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Gr√°ficos -->
<div class="row g-4 mb-4">
  <div class="col-md-8">
    <div class="card">
      <div class="card-header">
        <i class="bi bi-graph-up"></i> Liga√ß√µes nos √öltimos 7 Dias
      </div>
      <div class="card-body">
        <canvas id="chartLigacoesDias" height="80"></canvas>
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <i class="bi bi-pie-chart"></i> Resultados (30 dias)
      </div>
      <div class="card-body">
        <canvas id="chartResultados" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Ranking e Convers√£o -->
<div class="row g-4 mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <i class="bi bi-trophy-fill"></i> Ranking de Liga√ß√µes (30 dias)
      </div>
      <div class="table-container">
        <table class="table table-hover m-0">
          <thead>
            <tr>
              <th style="width: 60px">#</th>
              <th>Consultor</th>
              <th style="width: 120px" class="text-center">Liga√ß√µes</th>
              <th style="width: 80px"></th>
            </tr>
          </thead>
          <tbody>
            {% for r in ranking[:10] %}
            <tr>
              <td class="fw-bold text-center">
                {% if loop.index == 1 %}
                  <i class="bi bi-trophy-fill text-warning fs-5"></i>
                {% elif loop.index == 2 %}
                  <i class="bi bi-award-fill" style="color: #c0c0c0;"></i>
                {% elif loop.index == 3 %}
                  <i class="bi bi-award-fill" style="color: #cd7f32;"></i>
                {% else %}
                  {{ loop.index }}
                {% endif %}
              </td>
              <td>
                <div class="fw-bold">{{ r.nome }}</div>
              </td>
              <td class="text-center">
                <span class="badge bg-primary">{{ r.ligacoes }}</span>
              </td>
              <td>
                <div class="progress" style="height: 8px;">
                  {% set max_ligacoes = ranking[0].ligacoes if ranking else 1 %}
                  {% set percent = (r.ligacoes / max_ligacoes * 100) if max_ligacoes > 0 else 0 %}
                  <div class="progress-bar" style="width: {{ percent }}%; background: linear-gradient(90deg, #2563eb, #3b82f6);"></div>
                </div>
              </td>
            </tr>
            {% endfor %}
            {% if not ranking %}
            <tr>
              <td colspan="4" class="text-center text-muted py-4">
                Nenhum dado dispon√≠vel
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <i class="bi bi-graph-up-arrow"></i> Convers√£o & Receita (30 dias)
      </div>
      <div class="table-container">
        <table class="table table-hover m-0">
          <thead>
            <tr>
              <th>Consultor</th>
              <th class="text-center">Lig.</th>
              <th class="text-center">Vendas</th>
              <th class="text-center">Conv.</th>
              <th class="text-end">Receita</th>
            </tr>
          </thead>
          <tbody>
            {% for r in conversao %}
            <tr>
              <td>
                <div class="fw-bold">{{ r.nome }}</div>
              </td>
              <td class="text-center">
                <span class="text-muted">{{ r.ligacoes }}</span>
              </td>
              <td class="text-center">
                <span class="badge bg-success">{{ r.vendas }}</span>
              </td>
              <td class="text-center">
                <span class="badge {% if r.conversao >= 20 %}bg-success{% elif r.conversao >= 10 %}bg-warning{% else %}bg-secondary{% endif %}">
                  {{ r.conversao }}%
                </span>
              </td>
              <td class="text-end">
                <span class="fw-bold text-success">R$ {{ r.receita_fmt }}</span>
              </td>
            </tr>
            {% endfor %}
            {% if not conversao %}
            <tr>
              <td colspan="5" class="text-center text-muted py-4">
                Nenhum dado dispon√≠vel
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Liga√ß√µes por Dia (CLIC√ÅVEL) -->
<div class="row g-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <i class="bi bi-calendar3"></i> Liga√ß√µes por Dia (7 dias) - Clique para ver detalhes
      </div>
      <div class="table-container">
        <table class="table table-hover m-0">
          <thead>
            <tr>
              <th>Data</th>
              <th class="text-center">Total de Liga√ß√µes</th>
              <th style="width: 50%">Distribui√ß√£o</th>
              <th style="width: 10%"></th>
            </tr>
          </thead>
          <tbody>
            {% for d in ligacoes_por_dia %}
            <tr style="cursor: pointer;" onclick="verLigacoesDia('{{ d.data_iso }}', '{{ d.data }}')">
              <td>
                <div class="fw-bold">{{ d.data }}</div>
              </td>
              <td class="text-center">
                <span class="badge bg-primary">{{ d.total }}</span>
              </td>
              <td>
                <div class="progress" style="height: 24px;">
                  {% set max_dia = ligacoes_por_dia|map(attribute='total')|max if ligacoes_por_dia else 1 %}
                  {% set percent = (d.total / max_dia * 100) if max_dia > 0 else 0 %}
                  <div class="progress-bar" 
                       style="width: {{ percent }}%; background: linear-gradient(90deg, #2563eb 0%, #3b82f6 100%);">
                    {{ d.total }} liga√ß√µes
                  </div>
                </div>
              </td>
              <td class="text-center">
                <button class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-eye"></i> Ver
                </button>
              </td>
            </tr>
            {% endfor %}
            {% if not ligacoes_por_dia %}
            <tr>
              <td colspan="4" class="text-center text-muted py-4">
                Nenhuma liga√ß√£o nos √∫ltimos 7 dias
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Liga√ß√µes do Dia -->
<div class="modal fade" id="modalLigacoesDia" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-calendar-check"></i> Liga√ß√µes do Dia - <span id="dataSelecionada"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="ligacoesDiaContent">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status"></div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// Modal
let modalLigacoesDia;
document.addEventListener('DOMContentLoaded', () => {
  modalLigacoesDia = new bootstrap.Modal(document.getElementById('modalLigacoesDia'));
});

// üÜï FECHAR POP-UP DE NOVIDADES
async function fecharNovidades() {
  await fetch('/marcar-novidades-vistas', { method: 'POST' });
  document.getElementById('modalNovidades').style.display = 'none';
}

// üÜï APLICAR FILTRO POR M√äS
async function aplicarFiltroMes() {
  const select = document.getElementById('filtroMes');
  const valor = select.value; // formato: "mes-ano"
  const [mes, ano] = valor.split('-');
  
  const textoSelecionado = select.options[select.selectedIndex].text;
  document.getElementById('periodoSelecionado').textContent = textoSelecionado;
  
  // Mostrar loading
  document.getElementById('resultadosFiltrados').style.display = 'block';
  document.getElementById('tbodyResultados').innerHTML = `
    <tr>
      <td colspan="5" class="text-center py-4">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Carregando dados...</p>
      </td>
    </tr>
  `;
  
  try {
    const r = await fetch(`/api/resultados-por-mes?mes=${mes}&ano=${ano}`);
    const data = await r.json();
    
    if (!data.ok) {
      throw new Error(data.erro || 'Erro ao buscar dados');
    }
    
    const tbody = document.getElementById('tbodyResultados');
    
    if (!data.consultores || data.consultores.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center text-muted py-4">
            <i class="bi bi-inbox display-4 d-block mb-2"></i>
            Nenhum dado encontrado para este per√≠odo
          </td>
        </tr>
      `;
      return;
    }
    
    let html = '';
    data.consultores.forEach(c => {
      const badgeClass = c.conversao >= 20 ? 'bg-success' : 
                         c.conversao >= 10 ? 'bg-warning' : 'bg-secondary';
      
      html += `
        <tr>
          <td><strong>${c.nome}</strong></td>
          <td class="text-center"><span class="badge bg-primary">${c.total_ligacoes}</span></td>
          <td class="text-center"><span class="badge bg-success">${c.vendas}</span></td>
          <td class="text-center"><span class="badge ${badgeClass}">${c.conversao}%</span></td>
          <td class="text-end"><strong class="text-success">R$ ${c.receita_fmt}</strong></td>
        </tr>
      `;
    });
    
    tbody.innerHTML = html;
    
  } catch (erro) {
    console.error('Erro:', erro);
    document.getElementById('tbodyResultados').innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-danger py-4">
          <i class="bi bi-exclamation-triangle display-4 d-block mb-2"></i>
          Erro ao carregar dados: ${erro.message}
        </td>
      </tr>
    `;
  }
}

// Fun√ß√£o para ver liga√ß√µes do dia
async function verLigacoesDia(dataIso, dataFormatada) {
  document.getElementById('dataSelecionada').textContent = dataFormatada;
  modalLigacoesDia.show();
  
  try {
    const r = await fetch(`/ligacoes-dia/${dataIso}`);
    const ligacoes = await r.json();
    
    const content = document.getElementById('ligacoesDiaContent');
    
    if (!ligacoes || ligacoes.length === 0) {
      content.innerHTML = `
        <div class="text-center py-5">
          <i class="bi bi-inbox display-4 text-muted d-block mb-3"></i>
          <p class="text-muted">Nenhuma liga√ß√£o neste dia</p>
        </div>
      `;
      return;
    }
    
    const resultadoLabels = {
      'comprou': '<span class="badge bg-success"><i class="bi bi-cart-check"></i> Comprou</span>',
      'nao_comprou': '<span class="badge bg-secondary">N√£o comprou</span>',
      'retornar': '<span class="badge bg-warning"><i class="bi bi-arrow-clockwise"></i> Retornar</span>',
      'sem_interesse': '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Sem interesse</span>',
      'relacionamento': '<span class="badge bg-info"><i class="bi bi-heart"></i> Relacionamento</span>',
      'cliente_inativo': '<span class="badge bg-dark"><i class="bi bi-person-x"></i> Cliente Inativo</span>'
    };
    
    let html = `
      <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle"></i> <strong>${ligacoes.length}</strong> liga√ß√µes realizadas neste dia
      </div>
      <div class="row g-3">
    `;
    
    ligacoes.forEach((lig, idx) => {
      html += `
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h6 class="mb-1">
                    <i class="bi bi-clock"></i> ${lig.hora} - ${lig.consultor}
                  </h6>
                  <div class="text-muted small">
                    <i class="bi bi-building"></i> Cliente: <strong>${lig.cliente}</strong>
                  </div>
                </div>
                ${resultadoLabels[lig.resultado] || resultadoLabels['nao_comprou']}
              </div>
              
              <div class="row g-2 mt-2">
                ${lig.contato !== '-' ? `
                  <div class="col-md-4">
                    <small class="text-muted">Contato:</small><br>
                    <strong>${lig.contato}</strong>
                  </div>
                ` : ''}
                
                ${lig.valor !== '0,00' ? `
                  <div class="col-md-4">
                    <small class="text-muted">Valor:</small><br>
                    <strong class="text-success">R$ ${lig.valor}</strong>
                  </div>
                ` : ''}
              </div>
              
              ${lig.observacao ? `
                <div class="mt-3 p-3 bg-light rounded">
                  <small class="text-muted">Observa√ß√µes:</small><br>
                  ${lig.observacao}
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    content.innerHTML = html;
    
  } catch (error) {
    document.getElementById('ligacoesDiaContent').innerHTML = `
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> Erro: ${error.message}
      </div>
    `;
  }
}

// Configura√ß√£o dos gr√°ficos
Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
Chart.defaults.font.size = 13;

// Gr√°fico de Liga√ß√µes por Dia
const ctxDias = document.getElementById('chartLigacoesDias');
if (ctxDias) {
  const ligacoesDias = {{ ligacoes_por_dia|tojson|safe }};
  
  new Chart(ctxDias, {
    type: 'line',
    data: {
      labels: ligacoesDias.map(d => d.data).reverse(),
      datasets: [{
        label: 'Liga√ß√µes',
        data: ligacoesDias.map(d => d.total).reverse(),
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37, 99, 235, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 8,
        pointBackgroundColor: '#2563eb',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13 }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            callback: value => Number.isInteger(value) ? value : ''
          },
          grid: { color: 'rgba(0, 0, 0, 0.05)' }
        },
        x: { grid: { display: false } }
      }
    }
  });
}

// Gr√°fico de Resultados
const ctxResultados = document.getElementById('chartResultados');
if (ctxResultados) {
  const resultados = {{ resultados_chart|tojson|safe }};
  
  new Chart(ctxResultados, {
    type: 'doughnut',
    data: {
      labels: ['Comprou', 'N√£o Comprou', 'Retornar', 'Sem Interesse', 'Relacionamento', 'Cliente Inativo'],
      datasets: [{
        data: [
          resultados.comprou || 0,
          resultados.nao_comprou || 0,
          resultados.retornar || 0,
          resultados.sem_interesse || 0,
          resultados.relacionamento || 0,
          resultados.cliente_inativo || 0
        ],
        backgroundColor: [
          'rgba(16, 185, 129, 0.8)',
          'rgba(107, 114, 128, 0.8)',
          'rgba(245, 158, 11, 0.8)',
          'rgba(239, 68, 68, 0.8)',
          'rgba(59, 130, 246, 0.8)',
          'rgba(75, 85, 99, 0.8)'
        ],
        borderColor: ['#10b981', '#6b7280', '#f59e0b', '#ef4444', '#3b82f6', '#4b5563'],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { padding: 15, font: { size: 12 } }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          callbacks: {
            label: context => {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percent = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
              return `${context.label}: ${context.parsed} (${percent}%)`;
            }
          }
        }
      }
    }
  });
}
</script>
{% endblock %}