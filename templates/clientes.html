{% extends "layout.html" %}{% block content %}
<h4>Meus clientes</h4>
<a class="btn btn-sm btn-secondary mb-3" href="{{ url_for('importar_clientes') }}">Importar CSV</a>
<table class="table table-sm table-striped">
  <thead><tr><th>Nome</th><th>CNPJ</th><th>Telefone</th><th>Última ligação</th><th>Total</th><th>Ação</th></tr></thead>
  <tbody>
  {% for c in clientes %}
    <tr>
      <td>{{ c.nome }}</td><td>{{ c.cnpj or '' }}</td><td>{{ c.telefone or '' }}</td>
      <td>{{ c.ultima_ligacao.strftime('%d/%m/%Y %H:%M') if c.ultima_ligacao else '-' }}</td>
      <td>{{ c.total_ligacoes }}</td>
      <td>
        <button class="btn btn-sm btn-primary" onclick="registrar({{c.id}})">Registrar ligação</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="verHist({{c.id}})">Histórico</button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

<script>
async function registrar(id){
  const obs = prompt("Observação da ligação:");
  if (obs===null) return;
  const r = await fetch(`/registrar-ligacao/${id}`, {
    method: "POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify({observacao: obs})
  });
  const j = await r.json();
  alert(j.mensagem || JSON.stringify(j));
  location.reload();
}
async function verHist(id){
  const r = await fetch(`/historico-ligacoes/${id}`);
  const j = await r.json();
  let txt = j.map(l => `${l.data_hora} — ${l.consultor}: ${l.observacao||''}`).join('\n');
  alert(txt || "Sem registros.");
}
</script>
{% endblock %}
